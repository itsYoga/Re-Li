import{__assign as e,__awaiter as t,__generator as n,__spreadArray as i,__read as r}from"tslib";import{createLiffError as s,randomAlphaNumericString as a}from"@liff/util";import{SUB_WINDOW_STATUS as o,UNKNOWN as c}from"@liff/consts";var d="liff.subwindow.identifier",u="liff.subwindow.cryptokey",f=e(e({},o),{GET_DATA:"getData",SET_DATA:"setData",NOT_FOUND:"notFound",TEARDOWN:"teardown"}),l={BROADCAST:"broadcast",COMMAND:"command"},h={MAIN:"main",SUB:"sub"},v="__liff_message_bus__",p="bFSQbce18HC7UXe-lS_mgg",m=function(e){return t(void 0,void 0,void 0,(function(){var t;return n(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,window.crypto.subtle.importKey("jwk",{kty:"oct",k:e,alg:"A128GCM",ext:!0},{name:"AES-GCM"},!1,["encrypt","decrypt"])];case 1:return[2,n.sent()];case 2:throw t=n.sent(),s(c,t);case 3:return[2]}}))}))},w=function(e,i,r){return t(void 0,void 0,void 0,(function(){var t,a,o,d;return n(this,(function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),t=(new TextEncoder).encode(e),[4,m(i)];case 1:return a=n.sent(),[4,window.crypto.subtle.encrypt({name:"AES-GCM",iv:t},a,(new TextEncoder).encode(r))];case 2:return o=n.sent(),[2,btoa(new Uint8Array(o).reduce((function(e,t){return e+String.fromCharCode(t)}),""))];case 3:throw d=n.sent(),s(c,d);case 4:return[2]}}))}))},y=function(e,i,r){return t(void 0,void 0,void 0,(function(){var t,a,o,d,u,f,l;return n(this,(function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),t=(new TextEncoder).encode(e),[4,m(i)];case 1:for(a=n.sent(),o=atob(r),d=new Uint8Array(o.length),u=0;u<o.length;u++)d[u]=o.charCodeAt(u);return[4,window.crypto.subtle.decrypt({name:"AES-GCM",iv:t},a,d.buffer)];case 2:return f=n.sent(),[2,(new TextDecoder).decode(new Uint8Array(f))];case 3:throw l=n.sent(),s(c,l);case 4:return[2]}}))}))},g=function(e,t){return b(e)===b(t)},b=function(e){return"".concat(e.identifier,"-").concat(e.action,"-").concat(e.timestamp)},E=function(e){return Object.keys(o).map((function(e){return o[e]})).includes(e)?l.BROADCAST:l.COMMAND};function A(){var e=document.createElement("form");e.method="POST",e.action="$MESSAGE_HANDLER_URL";var t=document.createElement("input");t.type="hidden",t.name="identifier",t.value="$IDENTIFIER",e.appendChild(t),document.body.appendChild(e),e.submit()}var T=function(o){void 0===o&&(o=h.MAIN);var d=this;this.identification={identifier:"",cryptoKey:""},this.messageHandlerInstance=null,this.listeners=new Map,this.sentMessages=[],this.generateIdentification=function(){return t(d,void 0,void 0,(function(){var e,i,r,o,d;return n(this,(function(f){switch(f.label){case 0:return e=new URLSearchParams(window.location.search),i=function(t){var n=e.get("liff.state");return n?new URLSearchParams(n).get(t):null},r=this,d={identifier:this.windowType===h.MAIN?a(12):e.get("liff.subwindow.identifier")||i("liff.subwindow.identifier")||""},this.windowType!==h.MAIN?[3,2]:[4,t(void 0,void 0,void 0,(function(){var e,t,i;return n(this,(function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),[4,window.crypto.subtle.generateKey({name:"AES-GCM",length:128},!0,["encrypt","decrypt"])];case 1:return e=n.sent(),[4,window.crypto.subtle.exportKey("jwk",e)];case 2:if(!(t=n.sent())||!t.k)throw s(c,"failed to generate key");return[2,t.k];case 3:throw i=n.sent(),s(c,i);case 4:return[2]}}))}))];case 1:return o=f.sent(),[3,3];case 2:o=e.get(u)||i(u)||"",f.label=3;case 3:return r.identification=(d.cryptoKey=o,d),[2]}}))}))},this.hasIdentification=function(){var e=d.identification,t=e.identifier,n=e.cryptoKey;return"string"==typeof t&&"string"==typeof n&&t.length>0&&n.length>0},this.isReady=function(){return d.hasIdentification()&&!!d.messageHandlerInstance},this.setup=function(){return t(d,void 0,void 0,(function(){var e,t,i,r,a,o=this;return n(this,(function(n){switch(n.label){case 0:return this.messageHandlerInstance?[2]:[4,this.generateIdentification()];case 1:if(n.sent(),!(e=this.identification.identifier))return[2];if(t=/^[a-zA-Z0-9]+$/gm,!e.match(t))throw s(c,"Invalid identifier");return(i=document.createElement("iframe")).style.display="none",i.src="about:blank",document.body.appendChild(i),null===(a=null==i?void 0:i.contentWindow)||void 0===a||a.window.eval("(".concat(A.toString().replace("$MESSAGE_HANDLER_URL","".concat("https://liff-subwindow.line.me/liff/v2/sub/messageHandler")).replace("$IDENTIFIER",e.split("'")[0]),")()")),r="iframe-".concat(e,"-ready"),[4,new Promise((function(e){var t=function(n){n.data[r]&&(o.messageHandlerInstance=i,window.addEventListener("message",o.proxyToListeners),e(),document.removeEventListener("message",t))};window.addEventListener("message",t)}))];case 2:return[2,n.sent()]}}))}))},this.teardown=function(){return t(d,void 0,void 0,(function(){var e,t;return n(this,(function(n){switch(n.label){case 0:return this.isReady()?[4,this.send({eventName:f.TEARDOWN})]:[3,2];case 1:n.sent(),window.removeEventListener("message",this.proxyToListeners),this.listeners.clear(),null===(t=null===(e=this.messageHandlerInstance)||void 0===e?void 0:e.parentNode)||void 0===t||t.removeChild(this.messageHandlerInstance),this.messageHandlerInstance=null,n.label=2;case 2:return[2]}}))}))},this.listen=function(e){d.listeners.set(e,e)},this.listenRepliedEvent=function(e,t){var n=function(i){i.replyTarget&&g(i.replyTarget,e)&&(t(i),d.listeners.delete(n))};d.listeners.set(n,n)},this.send=function(e){return t(d,void 0,void 0,(function(){var t,i,r,a,o=this;return n(this,(function(n){switch(n.label){case 0:if(!this.isReady())throw s("message bus is not ready to send message");return i={action:E(e.eventName),identifier:this.identification.identifier||"",timestamp:(new Date).getTime()},[4,this.getEncryptedContext(e)];case 1:return i.context=n.sent(),t=i,null===(a=null===(r=this.messageHandlerInstance)||void 0===r?void 0:r.contentWindow)||void 0===a||a.postMessage({messageBusEvent:t},"*"),this.sentMessages.push(b(t)),[4,new Promise((function(e){o.listenRepliedEvent(t,(function(t){e(t.context)}))}))];case 2:return[2,n.sent()]}}))}))},this.reply=function(e,i){return t(d,void 0,void 0,(function(){var t,r,a,o;return n(this,(function(n){switch(n.label){case 0:if(!this.isReady())throw s("message bus is not ready to send message");if(!e.identifier||!e.timestamp)throw s(c,"target message is not valid");return r={action:l.BROADCAST},[4,this.getEncryptedContext(i)];case 1:return r.context=n.sent(),r.identifier=this.identification.identifier||"",r.timestamp=(new Date).getTime(),r.replyTarget={action:e.action,identifier:e.identifier,timestamp:e.timestamp},t=r,null===(o=null===(a=this.messageHandlerInstance)||void 0===a?void 0:a.contentWindow)||void 0===o||o.postMessage({messageBusEvent:t},"*"),this.sentMessages.push(b(t)),[2]}}))}))},this.setData=function(e,t){void 0===e&&(e="appData"),d.send({eventName:f.SET_DATA,key:e,data:t})},this.getData=function(){for(var e=[],s=0;s<arguments.length;s++)e[s]=arguments[s];return t(d,i([],r(e),!1),void 0,(function(e){return void 0===e&&(e="appData"),n(this,(function(t){switch(t.label){case 0:return[4,this.send({eventName:f.GET_DATA,key:e})];case 1:return[2,t.sent()]}}))}))},this.proxyToListeners=function(i){return t(d,void 0,void 0,(function(){var r,s=this;return n(this,(function(a){return r=i.data.messageBusEvent,"https://liff-subwindow.line.me"!==i.origin?[2]:r?(this.sentMessages.includes(b(r))||r.identifier!==this.identification.identifier||r.action!==l.BROADCAST&&!r.replyTarget||this.listeners.forEach((function(i){return t(s,void 0,void 0,(function(){var t,s,a;return n(this,(function(n){switch(n.label){case 0:return t=i,s=[e({},r)],a={},[4,this.getDecryptedContext(r.context)];case 1:return t.apply(void 0,[e.apply(void 0,s.concat([(a.context=n.sent(),a)]))]),[2]}}))}))})),[2]):[2]}))}))},this.getEncryptedContext=function(e){return t(d,void 0,void 0,(function(){var t,i,r,s,a,o,c;return n(this,(function(n){switch(n.label){case 0:return t=this.identification,i=t.identifier,r=t.cryptoKey,a=(s=JSON).stringify,c={eventName:e.eventName,key:e.key?e.key:void 0},e.data?[4,w(i,r,JSON.stringify(e.data))]:[3,2];case 1:return o=n.sent(),[3,3];case 2:o=void 0,n.label=3;case 3:return[2,a.apply(s,[(c.data=o,c)])]}}))}))},this.getDecryptedContext=function(i){return t(d,void 0,void 0,(function(){var t,r,s,a,o,c,d,u;return n(this,(function(n){switch(n.label){case 0:return t=this.identification,r=t.identifier,s=t.cryptoKey,(a=JSON.parse(i)).data&&"string"==typeof a.data?(u=(d=JSON).parse,[4,y(r,s,a.data)]):[3,2];case 1:return c=u.apply(d,[n.sent()]),[3,3];case 2:c=void 0,n.label=3;case 3:return o=c,[2,e(e({},a),{data:o})]}}))}))},this.windowType=o};export{l as ACTION,u as CRYPTO_KEY,f as EVENT_NAME,v as GLOBAL_MESSAGE_BUS_IDENTIFIER,p as GLOBAL_MESSAGE_BUS_KEY,d as IDENTIFIER_KEY,T as MessageBus,h as WINDOW,E as getEventAction,b as getUniqId,g as isSameEvent,A as loadMessageHandlerPage};
