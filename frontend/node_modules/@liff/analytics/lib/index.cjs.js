"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib"),t=require("@liff/consts"),i=require("@liff/logger"),r=require("@liff/util"),s=require("@liff/store"),n=require("@liff/use"),o=require("@liff/get-version"),a=require("@liff/is-logged-in"),u=require("@liff/get-profile");function c(){return e.__awaiter(this,void 0,void 0,(function(){var t,r;return e.__generator(this,(function(e){switch(e.label){case 0:if(!a.isLoggedIn())return[3,6];e.label=1;case 1:return e.trys.push([1,5,,6]),(t=s.getDecodedIDToken())&&t.sub?[2,t.sub]:[3,2];case 2:return[4,u.getProfile()];case 3:if((r=e.sent())&&r.userId)return[2,r.userId];e.label=4;case 4:return[3,6];case 5:return e.sent(),i.logger.debug("can't retrieve Mid/Uid because of something wrong"),[3,6];case 6:return[2]}}))}))}function f(){return e.__awaiter(this,void 0,void 0,(function(){var t;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,c()];case 1:return(t=e.sent())&&"u"===t.substring(0,1)?[2,t]:[2]}}))}))}var l=function(n){function u(){var t=n.apply(this,e.__spreadArray([],e.__read(arguments),!1))||this;return t.utsExtra={isLiffSuccessful:!1,isLoggedIn:!1,id:"",version:""},t.injected=!1,t}return e.__extends(u,n),Object.defineProperty(u,"CUSTOMPLACEID_INIT",{get:function(){return"liff.init"},enumerable:!1,configurable:!0}),Object.defineProperty(u,"CUSTOMTYPE",{get:function(){return"liffSdk"},enumerable:!1,configurable:!0}),Object.defineProperty(u,"LiffUtsLoginStatus",{get:function(){return{isLoggedIn:1,isLiffSuccessful:2}},enumerable:!1,configurable:!0}),Object.defineProperty(u.prototype,"name",{get:function(){return"analytics"},enumerable:!1,configurable:!0}),u.prototype.install=function(e){var t=e.liff,i=e.internalHooks;this.liffCore=t,i.init.beforeFinished(this.beforeInitFinished.bind(this)),i.init.beforeSuccess(this.beforeInitSuccess.bind(this)),i.init.error(this.initError.bind(this))},u.prototype.createDeprecatedUtsProxy=function(e){var t="LIFF Analytics is deprecated and will be removed in a future version. Please migrate to alternative analytics solutions.";return new Proxy(e,{get:function(e,r){var s=e[r];return"function"==typeof s?function(){for(var n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];return i.logger.warn("[LIFF Analytics] ".concat(t," Called method: ").concat(String(r))),s.apply(e,n)}:s}})},u.prototype.changeRatioToUTSFormat=function(e){if(e&&Number.isFinite(e))return Math.round(100*e)},u.prototype.setExtra=function(){var e,t=this.utsExtra,i=t.isLiffSuccessful,r=t.isLoggedIn,s=t.id,n=t.version,o=(r?u.LiffUtsLoginStatus.isLoggedIn:0)|(i?u.LiffUtsLoginStatus.isLiffSuccessful:0);null===(e=this.uts)||void 0===e||e.setExtra("liff",{id:s,loginStatus:o,version:n})},u.prototype.assignUtsExtra=function(e){Object.assign(this.utsExtra,e)},u.prototype.setVersion=function(e){this.assignUtsExtra({version:e}),i.logger.debug("[LIFFUTS][SDK version] ".concat(e)),this.setExtra()},u.prototype.setLiffId=function(e){this.assignUtsExtra({id:e}),i.logger.debug("[LIFFUTS][LIFFID] ".concat(e)),this.setExtra()},u.prototype.setIsLoggedIn=function(e){this.assignUtsExtra({isLoggedIn:e}),i.logger.debug("[LIFFUTS][isLoggedIn] ".concat(e)),this.setExtra()},u.prototype.sendLiffInit=function(){var e;i.logger.debug("[LIFFUTS][sendCustom] liff.init"),null===(e=this.uts)||void 0===e||e.sendCustom({type:u.CUSTOMTYPE,params:{placeId:u.CUSTOMPLACEID_INIT}})},u.prototype.setIsLiffSuccessful=function(e){this.assignUtsExtra({isLiffSuccessful:e}),i.logger.debug("[LIFFUTS][isLiffInitSuccessful] ".concat(e)),this.setExtra()},u.prototype.prepareReferrer=function(e){var i={};Object.keys(e).forEach((function(r){if(t.UTS_REFERRER_QUERY.includes(r)){var s=e[r];"string"==typeof s&&s&&(i[r.replace(/^liff\.ref\./,"")]=s)}})),Object.keys(i).length>0&&(this.referrer=i)},u.prototype.beforeInitFinished=function(){return e.__awaiter(this,void 0,void 0,(function(){var t,n,u,c,l,d,g,p,h,I,b,L;return e.__generator(this,(function(v){switch(v.label){case 0:if(t=r.qs.parse(window.location.search),this.prepareReferrer(t),n=s.getContext(),!(u=null==n?void 0:n.utsTracking))return[2];if(c=s.getConfig(),l=c.liffId,d=c.analytics,"auto"!==u.mode||!d)return[3,6];i.logger.warn("[LIFF Analytics] LIFF Analytics is deprecated and will be removed in a future version. Please migrate to alternative analytics solutions."),i.logger.debug("[LIFFUTS] ".concat((new Date).toUTCString())),v.label=1;case 1:return v.trys.push([1,3,,4]),g=this,[4,new Promise((function(e,t){var i=window.uts,r=document.createElement("script");r.type="text/javascript",r.src="https://static.line-scdn.net/uts/edge/4.1.0/uts.js",r.onload=function(){var t=window.uts;e(t),window.uts=i},r.onerror=function(e){t(e)},document.getElementsByTagName("head")[0].appendChild(r)}))];case 2:return g.uts=v.sent(),[3,4];case 3:return p=v.sent(),i.logger.debug("[LIFFUTS] cannot load UTS, reason: ".concat(p)),[2];case 4:return h=e.__assign(e.__assign({},d.context),{utsId:d.context.utsId,appName:d.context.appName,appEnv:d.context.appEnv||"release"}),I=e.__assign(e.__assign({endpoint:"https://uts-front.line-apps.com"},d.options),{sampleRate:this.changeRatioToUTSFormat(u.sendRatio),version:"current"}),this.uts.init(h,I),[4,f()];case 5:(b=v.sent())&&(i.logger.debug("[LIFFUTS][mid] ".concat(b)),this.uts.setMid(b)),(null==n?void 0:n.tid)&&(i.logger.debug("[LIFFUTS][tid] ".concat(n.tid)),this.uts.setTid(n.tid)),this.referrer&&(i.logger.debug("liff.ref.referrer",this.referrer),this.uts.setSessionParams(this.referrer)),l&&this.setLiffId(l),this.setIsLoggedIn(a.isLoggedIn()),this.setVersion(o.getVersion()),L=r.removeCredential(location.href),i.logger.debug("[LIFFUTS][url] ".concat(L)),this.uts.setUrl(L),this.liffCore.analytics=this.createDeprecatedUtsProxy(this.uts),this.injected=!0,v.label=6;case 6:return[2]}}))}))},u.prototype.beforeInitSuccess=function(){return this.injected&&(this.setIsLiffSuccessful(!0),this.sendLiffInit()),Promise.resolve()},u.prototype.initError=function(){return this.injected&&(this.setIsLiffSuccessful(!1),this.sendLiffInit()),Promise.resolve()},u}(n.LiffModule);exports.AnalyticsModule=l,exports.sendShareTargetPicker=function(e){i.logger.warn("[LIFF Analytics] LIFF Analytics is deprecated and will be removed in a future version. Please migrate to alternative analytics solutions. Called function: sendShareTargetPicker"),i.logger.debug("[LIFFUTS][sendCustom] liff.shareTargetPicker"),e.sendCustom({type:"liffSdk",params:{placeId:"liff.shareTargetPicker"}})};
