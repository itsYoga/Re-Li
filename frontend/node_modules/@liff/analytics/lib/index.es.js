import{__awaiter as t,__generator as e,__extends as i,__spreadArray as r,__read as n,__assign as s}from"tslib";import{UTS_REFERRER_QUERY as o}from"@liff/consts";import{logger as a}from"@liff/logger";import{removeCredential as u,qs as f}from"@liff/util";import{getDecodedIDToken as c,getContext as l,getConfig as d}from"@liff/store";import{LiffModule as p}from"@liff/use";import{getVersion as h}from"@liff/get-version";import{isLoggedIn as g}from"@liff/is-logged-in";import{getProfile as m}from"@liff/get-profile";function I(){return t(this,void 0,void 0,(function(){var t,i;return e(this,(function(e){switch(e.label){case 0:if(!g())return[3,6];e.label=1;case 1:return e.trys.push([1,5,,6]),(t=c())&&t.sub?[2,t.sub]:[3,2];case 2:return[4,m()];case 3:if((i=e.sent())&&i.userId)return[2,i.userId];e.label=4;case 4:return[3,6];case 5:return e.sent(),a.debug("can't retrieve Mid/Uid because of something wrong"),[3,6];case 6:return[2]}}))}))}function b(){return t(this,void 0,void 0,(function(){var t;return e(this,(function(e){switch(e.label){case 0:return[4,I()];case 1:return(t=e.sent())&&"u"===t.substring(0,1)?[2,t]:[2]}}))}))}var L=function(c){function p(){var t=c.apply(this,r([],n(arguments),!1))||this;return t.utsExtra={isLiffSuccessful:!1,isLoggedIn:!1,id:"",version:""},t.injected=!1,t}return i(p,c),Object.defineProperty(p,"CUSTOMPLACEID_INIT",{get:function(){return"liff.init"},enumerable:!1,configurable:!0}),Object.defineProperty(p,"CUSTOMTYPE",{get:function(){return"liffSdk"},enumerable:!1,configurable:!0}),Object.defineProperty(p,"LiffUtsLoginStatus",{get:function(){return{isLoggedIn:1,isLiffSuccessful:2}},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"name",{get:function(){return"analytics"},enumerable:!1,configurable:!0}),p.prototype.install=function(t){var e=t.liff,i=t.internalHooks;this.liffCore=e,i.init.beforeFinished(this.beforeInitFinished.bind(this)),i.init.beforeSuccess(this.beforeInitSuccess.bind(this)),i.init.error(this.initError.bind(this))},p.prototype.createDeprecatedUtsProxy=function(t){var e="LIFF Analytics is deprecated and will be removed in a future version. Please migrate to alternative analytics solutions.";return new Proxy(t,{get:function(t,i){var r=t[i];return"function"==typeof r?function(){for(var n=[],s=0;s<arguments.length;s++)n[s]=arguments[s];return a.warn("[LIFF Analytics] ".concat(e," Called method: ").concat(String(i))),r.apply(t,n)}:r}})},p.prototype.changeRatioToUTSFormat=function(t){if(t&&Number.isFinite(t))return Math.round(100*t)},p.prototype.setExtra=function(){var t,e=this.utsExtra,i=e.isLiffSuccessful,r=e.isLoggedIn,n=e.id,s=e.version,o=(r?p.LiffUtsLoginStatus.isLoggedIn:0)|(i?p.LiffUtsLoginStatus.isLiffSuccessful:0);null===(t=this.uts)||void 0===t||t.setExtra("liff",{id:n,loginStatus:o,version:s})},p.prototype.assignUtsExtra=function(t){Object.assign(this.utsExtra,t)},p.prototype.setVersion=function(t){this.assignUtsExtra({version:t}),a.debug("[LIFFUTS][SDK version] ".concat(t)),this.setExtra()},p.prototype.setLiffId=function(t){this.assignUtsExtra({id:t}),a.debug("[LIFFUTS][LIFFID] ".concat(t)),this.setExtra()},p.prototype.setIsLoggedIn=function(t){this.assignUtsExtra({isLoggedIn:t}),a.debug("[LIFFUTS][isLoggedIn] ".concat(t)),this.setExtra()},p.prototype.sendLiffInit=function(){var t;a.debug("[LIFFUTS][sendCustom] liff.init"),null===(t=this.uts)||void 0===t||t.sendCustom({type:p.CUSTOMTYPE,params:{placeId:p.CUSTOMPLACEID_INIT}})},p.prototype.setIsLiffSuccessful=function(t){this.assignUtsExtra({isLiffSuccessful:t}),a.debug("[LIFFUTS][isLiffInitSuccessful] ".concat(t)),this.setExtra()},p.prototype.prepareReferrer=function(t){var e={};Object.keys(t).forEach((function(i){if(o.includes(i)){var r=t[i];"string"==typeof r&&r&&(e[i.replace(/^liff\.ref\./,"")]=r)}})),Object.keys(e).length>0&&(this.referrer=e)},p.prototype.beforeInitFinished=function(){return t(this,void 0,void 0,(function(){var t,i,r,n,o,c,p,m,I,L,v,y;return e(this,(function(e){switch(e.label){case 0:if(t=f.parse(window.location.search),this.prepareReferrer(t),i=l(),!(r=null==i?void 0:i.utsTracking))return[2];if(n=d(),o=n.liffId,c=n.analytics,"auto"!==r.mode||!c)return[3,6];a.warn("[LIFF Analytics] LIFF Analytics is deprecated and will be removed in a future version. Please migrate to alternative analytics solutions."),a.debug("[LIFFUTS] ".concat((new Date).toUTCString())),e.label=1;case 1:return e.trys.push([1,3,,4]),p=this,[4,new Promise((function(t,e){var i=window.uts,r=document.createElement("script");r.type="text/javascript",r.src="https://static.line-scdn.net/uts/edge/4.1.0/uts.js",r.onload=function(){var e=window.uts;t(e),window.uts=i},r.onerror=function(t){e(t)},document.getElementsByTagName("head")[0].appendChild(r)}))];case 2:return p.uts=e.sent(),[3,4];case 3:return m=e.sent(),a.debug("[LIFFUTS] cannot load UTS, reason: ".concat(m)),[2];case 4:return I=s(s({},c.context),{utsId:c.context.utsId,appName:c.context.appName,appEnv:c.context.appEnv||"release"}),L=s(s({endpoint:"https://uts-front.line-apps.com"},c.options),{sampleRate:this.changeRatioToUTSFormat(r.sendRatio),version:"current"}),this.uts.init(I,L),[4,b()];case 5:(v=e.sent())&&(a.debug("[LIFFUTS][mid] ".concat(v)),this.uts.setMid(v)),(null==i?void 0:i.tid)&&(a.debug("[LIFFUTS][tid] ".concat(i.tid)),this.uts.setTid(i.tid)),this.referrer&&(a.debug("liff.ref.referrer",this.referrer),this.uts.setSessionParams(this.referrer)),o&&this.setLiffId(o),this.setIsLoggedIn(g()),this.setVersion(h()),y=u(location.href),a.debug("[LIFFUTS][url] ".concat(y)),this.uts.setUrl(y),this.liffCore.analytics=this.createDeprecatedUtsProxy(this.uts),this.injected=!0,e.label=6;case 6:return[2]}}))}))},p.prototype.beforeInitSuccess=function(){return this.injected&&(this.setIsLiffSuccessful(!0),this.sendLiffInit()),Promise.resolve()},p.prototype.initError=function(){return this.injected&&(this.setIsLiffSuccessful(!1),this.sendLiffInit()),Promise.resolve()},p}(p),v=function(t){a.warn("[LIFF Analytics] LIFF Analytics is deprecated and will be removed in a future version. Please migrate to alternative analytics solutions. Called function: sendShareTargetPicker"),a.debug("[LIFFUTS][sendCustom] liff.shareTargetPicker"),t.sendCustom({type:"liffSdk",params:{placeId:"liff.shareTargetPicker"}})};export{L as AnalyticsModule,v as sendShareTargetPicker};
