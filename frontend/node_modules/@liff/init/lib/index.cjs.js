"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("tslib"),t=require("@liff/use"),r=require("@liff/ready"),n=require("@liff/is-logged-in"),o=require("@liff/util"),i=require("@liff/store"),a=require("@liff/check-availability"),s=require("@liff/consts"),c=require("@liff/extensions"),l=require("@liff/is-in-client"),f=require("@liff/logout"),u=require("@liff/is-sub-window"),d=require("@liff/permanent-link"),h=require("@liff/sub-window"),g=require("@liff/server-api"),_=require("@liff/logger"),p=require("@liff/get-line-version"),v=require("@liff/native-bridge"),w=require("@liff/is-api-available"),I=require("@liff/get-os"),b=require("@liff/login"),m=require("@liff/close-window"),C=require("@liff/message-bus"),T=require("@liff/hooks"),k=require("@liff/i18n"),F={iconColor:"#111111",statusBarColor:"BLACK",titleTextColor:"#111111",titleSubtextColor:"#B7B7B7",titleButtonColor:"#111111",titleBackgroundColor:"#FFFFFF",progressBarColor:"#06C755",progressBackgroundColor:"#FFFFFF",titleButtonAreaBackgroundColor:"#1FFFFFFF",titleButtonAreaBorderColor:"#26000000",baseBackgroundColor:"#FFFFFF",baseTextColor:"#000000",lightButtonBorderColor:"rgba(0, 0, 0, 0.15)"},E={iconColor:"#FFFFFF",statusBarColor:"WHITE",titleTextColor:"#FFFFFF",titleSubtextColor:"#949494",titleButtonColor:"#FFFFFF",titleBackgroundColor:"#111111",progressBarColor:"#06C755",progressBackgroundColor:"#111111",titleButtonAreaBackgroundColor:"#1FFFFFFF",titleButtonAreaBorderColor:"#26000000",baseBackgroundColor:"#000000",baseTextColor:"#FFFFFF",lightButtonBorderColor:"rgba(255, 255, 255, 0.5)"};function L(){var e;y("color-scheme",((null==(e=i.getContext())?void 0:e.menuColorSetting)||{adaptableColorSchemes:["light"]}).adaptableColorSchemes.join(" "));var t=window.matchMedia("(prefers-color-scheme: dark)");A({matches:null==t?void 0:t.matches,media:null==t?void 0:t.media}),t.addEventListener?t.addEventListener("change",A):t.addListener&&t.addListener(A)}function A(t){var r=i.getContext(),n=(null==r?void 0:r.menuColorSetting)||{adaptableColorSchemes:["light"],lightModeColor:F,darkModeColor:E},o=n.adaptableColorSchemes,a=n.lightModeColor,s=n.darkModeColor,c=o.includes("dark");t.matches&&c?D(e.__assign(e.__assign({},E),s)):D(e.__assign(e.__assign({},F),a))}function D(e){var t=e.iconColor,r=e.statusBarColor,n=e.titleTextColor,i=e.titleSubtextColor,a=e.titleButtonColor,s=e.titleBackgroundColor,c=e.progressBarColor,l=e.progressBackgroundColor,f=e.titleButtonAreaBackgroundColor,u=e.titleButtonAreaBorderColor,d=e.baseBackgroundColor,h=e.baseTextColor,g=e.lightButtonBorderColor;y("--liff-base-background-color",d),y("--liff-base-text-color",h),y("--liff-base-background-rgb-color",o.convertHexToRgb(d)),y("--liff-base-text-rgb-color",o.convertHexToRgb(h)),y("--liff-light-button-border-color",g),y("--liff-title-text-color",n),y("--liff-title-background-color",s),y("--liff-title-button-color",a),y("--liff-icon-color",t),y("--liff-status-bar-color",r),y("--liff-title-subtext-color",i),y("--liff-progress-bar-color",c),y("--liff-progress-background-color",l),y("--liff-title-button-area-background-color",o.convertArgbToRgba(f)),y("--liff-title-button-area-border-color",o.convertArgbToRgba(u))}function y(e,t){document.documentElement.style.setProperty(e,t)}var S={addToHomeScreen:function(e){if(!new a.CheckAvailability(e).invoke("addToHomeScreen"))throw o.createLiffError(s.FORBIDDEN,"No permission for liff.addToHomeScreen()")},scanCode:function(e){if(!new a.CheckAvailability(e).invoke("scanCode"))return Promise.reject(o.createLiffError(s.FORBIDDEN,"No permission for liff.scanCode()"))},getAdvertisingId:function(e){if(!new a.CheckAvailability(e).invoke("getAdvertisingId"))return Promise.reject(o.createLiffError(s.FORBIDDEN,"No permission for liff.getAdvertisingId()"))},initPlugins:function(){}};function N(t){return e.__awaiter(this,void 0,void 0,(function(){var r;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,c.load()];case 1:return(r=e.sent())?(r.install(t,S),[2]):[2]}}))}))}function B(){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return[4,g.fetch(g.getEndPoint("certs"))];case 1:return[2,e.sent()]}}))}))}function x(t,r,n){return e.__awaiter(this,void 0,void 0,(function(){var o;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,crypto.subtle.importKey("jwk",t,{name:"ECDSA",namedCurve:"P-256"},!1,["verify"])];case 1:return o=e.sent(),[4,crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},o,n,r)];case 2:return[2,e.sent()]}}))}))}function O(t,r){return e.__awaiter(this,void 0,void 0,(function(){var n,i,a,c,l,f,u,d,h,g,_,p,v,w,I,b;return e.__generator(this,(function(m){switch(m.label){case 0:return n=t.split("."),i=e.__read(n,3),a=i[0],c=i[1],l=i[2],f=JSON.parse(o.base64Url.decode(a)),u=JSON.parse(o.base64Url.decodeUnicode(c)),d=o.convertArrayBuffer(o.base64Url.decode(l)),h=o.convertArrayBuffer("".concat(a,".").concat(c)),[4,B()];case 1:if(g=m.sent(),!(_=g.keys.find((function(e){return e.kid===f.kid}))))return[3,6];if(delete _.alg,"ES256"!==f.alg)throw o.createLiffError(s.INVALID_ID_TOKEN,'Invalid "alg" value in ID_TOKEN');p=void 0,m.label=2;case 2:return m.trys.push([2,4,,5]),[4,x(_,h,d)];case 3:return p=m.sent(),[3,5];case 4:throw v=m.sent(),o.createLiffError(s.INVALID_ID_TOKEN,"".concat("Failed to use Crypto API to verify ID_TOKEN",": ").concat(v));case 5:if(p){if(w=u.iss!=="https://access.".concat("line.me"),I=u.aud!==r,b=1e3*u.exp<Date.now(),w)throw o.createLiffError(s.INVALID_ID_TOKEN,'Invalid "iss" value in ID_TOKEN');if(I)throw o.createLiffError(s.INVALID_ID_TOKEN,'Invalid "aud" value in ID_TOKEN');if(b)throw o.createLiffError(s.INVALID_ID_TOKEN,'Invalid "exp" value in ID_TOKEN');return[2,u]}throw o.createLiffError(s.INVALID_ID_TOKEN,"Invalid signature in ID_TOKEN");case 6:throw o.createLiffError(s.INVALID_ID_TOKEN,'Invalid "kid" value in ID_TOKEN');case 7:return[2]}}))}))}function U(e){var t=e.split(".");if(t[1])try{var r=t[1].replace(/-/g,"+").replace(/_/g,"/");return JSON.parse(window.atob(r))}catch(n){return null}return null}function q(e){var t=e.pathname,r=e.query,n=r?"?".concat(o.qs.stringify(r)):"",i="".concat("liff://").concat(t).concat(n);location.href=i}var W=null;function M(){"boolean"==typeof W&&_.logger.warn("liff.init is not expected to be called more than once"),W=!!i.getIsSubsequentLiffApp()||!(!l.isInClient()||o.qs.parse(window.location.hash).feature_token||i.getFeatureToken())&&(i.setIsSubsequentLiffApp(!0),!0)}function P(){return Boolean(W)}function H(t,r){return e.__awaiter(this,void 0,void 0,(function(){var n;return e.__generator(this,(function(e){switch(e.label){case 0:return(n=i.getMST())?[2,n]:t&&r?[4,h.getMSTByMSIT({msit:t,mstVerifier:r})]:[3,2];case 1:return[2,e.sent().mst];case 2:return[2,null]}}))}))}function R(e){return g.fetch("".concat(g.getEndPoint("apps"),"/").concat(e,"/featureToken"))}function V(t){return e.__awaiter(this,void 0,void 0,(function(){var r,a,s,c;return e.__generator(this,(function(l){switch(l.label){case 0:return r=o.qs.parse(window.location.hash),a=function(t){for(var r,n,o=[],i=1;i<arguments.length;i++)o[i-1]=arguments[i];var a=function(e){Object.keys(e).filter((function(t){return null!==e[t]&&void 0!==e[t]})).forEach((function(r){t[r]=e[r]}))};try{for(var s=e.__values(o),c=s.next();!c.done;c=s.next()){a(c.value)}}catch(l){r={error:l}}finally{try{c&&!c.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}return t}({access_token:i.getAccessToken(),context_token:i.getRawContext(),feature_token:i.getFeatureToken(),id_token:i.getIDToken(),client_id:i.getClientId(),mst_challenge:i.getMSTChallenge(),mst_verifier:i.getMSTVerifier(),msit:i.getMSIT()},r),P()?n.isLoggedIn()?[4,R(t)]:[3,2]:[3,3];case 1:s=l.sent().featureToken,a.feature_token||(a.feature_token=s),l.label=2;case 2:(c=o.extractChannelIdFromLiffId(t))&&(a.client_id=c),l.label=3;case 3:return[2,a]}}))}))}function K(e){if(e.persisted&&w.isApiAvailable("multipleLiffTransition"))if("ios"===I.getOS())window.location.reload();else{var t=i.getConfig().liffId,r=i.getFeatureToken();if(!t)throw o.createLiffError(s.INIT_FAILED,"Invalid LIFF ID.");if(!r)throw o.createLiffError(s.FORBIDDEN,"Invalid featureToken for client features");q({pathname:"app/".concat(t),query:{feature_token:r}})}}function j(t){return e.__awaiter(this,void 0,void 0,(function(){var r,a,c,l,f,d,I,m,C,T,k,F,E,L,A,D,y,S,N;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,new Promise((function(e){var t=p.getLineVersion();if(!t||o.compareVersion(t,"9.5.0")<0)e();else if(window._liff&&window._liff.features)e();else{_.logger.debug("cannot find window._liff.features, listen to ready event");var r=function(){_.logger.debug("ready event is fired"),v.removeListener("ready",r),e()};v.addListener("ready",r)}}))];case 1:return e.sent(),M(),[4,V(t.liffId)];case 2:if(r=e.sent(),a=r.access_token,c=r.context_token,l=r.feature_token,f=r.id_token,d=r.client_id,I=r.mst_verifier,m=r.mst_challenge,C=r.msit,c){if("string"!=typeof c)throw o.createLiffError(s.INIT_FAILED,"Cannot get context token, perhaps there is an incorrect parameter in permanent link");i.setContext(U(c))}if(void 0!==(null===(S=i.getContext())||void 0===S?void 0:S.liffId)&&(null===(N=i.getContext())||void 0===N?void 0:N.liffId)!==t.liffId)throw o.createLiffError(s.INIT_FAILED,"Invalid LIFF ID");return!u.isSubWindow()&&l&&(!function(e,t){w.isApiAvailable("multipleLiffTransition")&&q({pathname:"app/".concat(e),query:{feature_token:t}})}(t.liffId,l),P()&&i.setFeatureToken(l)),m&&i.setMSTChallenge(m),I&&i.setMSTVerifier(I),d&&i.setClientId(d),C&&i.setMSIT(C),window.addEventListener("pageshow",K),n.isLoggedIn()?[3,5]:l&&a?[3,5]:P()?(T=o.addParamsToUrl(location.href,{"liff.hback":"2"}),b.login({redirectUri:T}),[4,new Promise((function(){}))]):[3,4];case 3:e.sent(),e.label=4;case 4:throw b.login(),o.createLiffError(s.INIT_FAILED,"Failed to parse feature_token or access_token");case 5:return a&&l?[4,g.verifyAccessToken(a)]:[3,7];case 6:if(k=e.sent(),F=k.client_id,E=k.expires_in,L=o.extractChannelIdFromLiffId(t.liffId),F!==L)throw b.login(),o.createLiffError(s.INIT_FAILED,"Failed to verify access_token");i.setFeatureToken(l),i.setExpireTime(new Date(Date.now()+1e3*E)),i.setAccessToken(a),e.label=7;case 7:return[4,H(C,I)];case 8:return(A=e.sent())?(i.setMST(A),[4,h.getAppData({mst:A})]):[3,10];case 9:(D=e.sent().data)&&i.setAppData(JSON.stringify(D)),e.label=10;case 10:return f&&!i.getIDToken()&&i.setIDToken(f),f&&d&&!i.getDecodedIDToken()?[4,O(f,d)]:[3,12];case 11:(y=e.sent())&&i.setDecodedIDToken(y),e.label=12;case 12:return[2]}}))}))}function J(t){return e.__awaiter(this,void 0,void 0,(function(){var r,n,a,c,l,f,u;return e.__generator(this,(function(e){switch(e.label){case 0:return r=g.getEndPoint("apps"),n="".concat(r,"/").concat(t,"/contextToken"),a=i.getAccessToken(),c={"Content-Type":"application/json",Accept:"application/json"},a&&(c.Authorization="Bearer ".concat(a)),[4,g.fetch(n,{headers:c})];case 1:if(l=e.sent(),!(f=l.contextToken))throw o.createLiffError(s.INIT_FAILED,"Can not get context from server.");if(!(u=U(f)))throw o.createLiffError(s.INIT_FAILED,"Invalid context token.");return[2,u]}}))}))}function G(){return e.__awaiter(this,void 0,void 0,(function(){var t,r;return e.__generator(this,(function(e){switch(e.label){case 0:if(!(t=i.getConfig().liffId))throw o.createLiffError(s.INIT_FAILED,"Invalid LIFF ID.");return[4,J(t)];case 1:return r=e.sent(),i.setContext(r),[2]}}))}))}function z(t){return e.__awaiter(this,void 0,void 0,(function(){var r,n,a,s=this;return e.__generator(this,(function(c){switch(c.label){case 0:r=function(){return e.__awaiter(s,void 0,void 0,(function(){var r,n,a,s,c,l;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,(f=i.getConfig(),u=o.qs.parse(window.location.search),d=i.getLoginTmp(),h={grant_type:"authorization_code",client_id:u.liffClientId,appId:f.liffId,code:u.code,code_verifier:d.codeVerifier,redirect_uri:f.redirectUri||u.liffRedirectUri,id_token_key_type:"JWK"},_=o.qs.stringify(h),g.fetch(g.getEndPoint("token"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:_}))];case 1:return r=e.sent(),n=r.access_token,a=r.id_token,s=r.expires_in,i.setClientId(t),i.setAccessToken(n),i.setExpireTime(new Date(Date.now()+1e3*s)),i.removeLoginTmp(),a?(i.setIDToken(a),[4,O(a,t)]):[3,3];case 2:(c=e.sent())&&i.setDecodedIDToken(c),e.label=3;case 3:return(l=o.qs.parse(location.hash).context_token)?(i.setContext(U(l)),[3,6]):[3,4];case 4:return[4,G()];case 5:e.sent(),e.label=6;case 6:return[2]}var f,u,d,h,_}))}))},c.label=1;case 1:return c.trys.push([1,3,,4]),[4,r()];case 2:return c.sent(),[3,4];case 3:throw n=c.sent(),a=n,i.removeLoginTmp(),a;case 4:return[2]}}))}))}function Y(){return e.__awaiter(this,void 0,void 0,(function(){var t,r,a,c,l,f,u=this;return e.__generator(this,(function(d){switch(d.label){case 0:return(r=h.getMessageBus())?[3,2]:[4,h.initMessageBus(C.WINDOW.SUB)];case 1:r=d.sent(),d.label=2;case 2:return(t=r).isReady()?(a=o.randomAlphaNumericString(8),[4,t.getData("appData")]):[3,8];case 3:return c=d.sent(),l=c.eventName,f=c.data,l!==C.EVENT_NAME.NOT_FOUND?[3,6]:[4,t.teardown()];case 4:return d.sent(),[4,Y()];case 5:return[2,d.sent()];case 6:f&&i.setAppData(JSON.stringify(f)),d.label=7;case 7:return t.listen((function(r){return e.__awaiter(u,void 0,void 0,(function(){var n,o;return e.__generator(this,(function(e){return n=r.context,o=n.data,n.eventName===s.SUB_WINDOW_STATUS.INIT&&(null==o?void 0:o.subWindowId)!==a&&m.closeWindow(),n.eventName!==s.SUB_WINDOW_STATUS.CANCEL&&n.eventName!==s.SUB_WINDOW_STATUS.SUBMIT||t.teardown(),[2]}))}))})),n.isLoggedIn()&&t.send({eventName:s.SUB_WINDOW_STATUS.INIT,data:{subWindowId:a,hasOpener:!!window.opener}}),[3,10];case 8:return h.getMainWindowOrigin()?[3,10]:[4,new Promise((function(e){window.addEventListener("message",function(e){return function t(r){var n=r.data,o=r.source,a=r.origin;if(n){var c=n.type,l=n.message;c===s.SUB_WINDOW_HEALTH_CHECK_MESSAGE&&(window.removeEventListener("message",t),l&&i.setAppData(l),h.setMainWindowOrigin(a),o&&o.postMessage&&o.postMessage({status:s.SUB_WINDOW_HEALTH_CHECK_MESSAGE},a),e())}}}(e))}))];case 9:return[2,d.sent()];case 10:return[2]}}))}))}var Q=new(function(){function t(){var e=this;this.getAndValidateContext=function(){var e=i.getContext();if(!e)throw o.createLiffError(s.INIT_FAILED,"Could not get Context from server.");if(!e.endpointUrl)throw o.createLiffError(s.INIT_FAILED,"Could not get endpointUrl from server.");if(!e.permanentLinkPattern)throw o.createLiffError(s.INIT_FAILED,"Could not get permanentLinkPattern from server.");return e},this.decodeState=function(t){var r=e.getAndValidateContext();t=t.replace(/\n/g,"%0D%0A");var n=e.hasTrailingSlash(r.endpointUrl)||e.hasTrailingSlash(t),o=new URL(r.endpointUrl),i=o.origin,a=o.pathname,s=o.search,c=new URL("".concat(i).concat(e.attachSlashAtStart(t))),l=c.pathname,f=c.search,u=c.hash,d="".concat(s).concat(s?f.replace(/\?/g,"&"):f),h="".concat(a).concat(e.attachSlashAtStart(l)).replace("//","/");return(h=e.attachSlashAtStart("".concat(h))).endsWith("/")&&!n&&(h=h.substring(0,h.length-1)),"".concat(i).concat(h).concat(d).concat(u).replace(/%0D%0A/g,"\n")}}return t.prototype.attachSlashAtStart=function(e){return"".concat(e&&e.length>0&&!e.startsWith("/")?"/":"").concat(e)},t.prototype.hasTrailingSlash=function(e){var t=e.indexOf("?"),r=e.indexOf("#"),n=-1;return(n=-1===t&&-1===r?e.length:-1===t?r:-1===r?t:Math.min(t,r))>0&&"/"===e[n-1]},t.prototype.invoke=function(){return e.__awaiter(this,void 0,void 0,(function(){var t,r,n,i,a;return e.__generator(this,(function(e){switch(e.label){case 0:if(t=o.qs.parse(window.location.search),"string"!=typeof(r=t["liff.state"]))return[2];e.label=1;case 1:return e.trys.push([1,4,,5]),n=location.href,(i=this.decodeState(r))===n?[3,3]:(t["liff.hback"]?location.replace(o.addParamsToUrl(i,{"liff.hback":t["liff.hback"]})):location.replace(i),[4,new Promise((function(){}))]);case 2:e.sent(),e.label=3;case 3:return[3,5];case 4:if((a=e.sent()).code===s.INIT_FAILED)throw a;return _.logger.debug(a),[3,5];case 5:return[2]}}))}))},t}());function X(t,r){return e.__awaiter(this,void 0,void 0,(function(){var a,c;return e.__generator(this,(function(e){switch(e.label){case 0:if(!t.liffId)throw o.createLiffError(s.INVALID_CONFIG,"liffId is necessary for liff.init()");return i.setConfig(t),!l.isInClient()&&n.isLoggedIn()&&(i.getExpireTime()||f.logout()),a=o.qs.parse(window.location.search),!u.isSubWindow()||l.isInClient()?[3,2]:[4,Y()];case 1:e.sent(),e.label=2;case 2:if(a.error&&a.liffOAuth2Error)throw p=a.error,v=a.error_description,w=v.replace(/\+/g," "),I="".concat(p,": ").concat(w),o.createLiffError(s.INIT_FAILED,I);return h=a.code,g=i.getLoginTmp(),Boolean(h&&!n.isLoggedIn()&&g&&g.codeVerifier)?[4,z(a.liffClientId)]:[3,4];case 3:e.sent(),e.label=4;case 4:return l.isInClient()?[4,j(t)]:[3,6];case 5:return e.sent(),[3,8];case 6:return n.isLoggedIn()?[3,8]:[4,G()];case 7:e.sent(),e.label=8;case 8:return[4,Q.invoke()];case 9:if(e.sent(),c=i.getContext())try{d.validatePermalinkGeneratability(location.href,c.endpointUrl)}catch(b){_.logger.warn("liff.init() was called with a current URL that is not related to the endpoint URL.\n".concat(location.href," is not under ").concat(c.endpointUrl))}return[4,r()];case 10:return e.sent(),o.replaceUrlCredentialRemoved(window.location.href),[2]}var h,g,p,v,w,I}))}))}var Z=function(e,t){return new Promise((function(r,n){if(e){var i=document.createElement("script");i.type="module",i.onload=function(){r()},i.src=e,document.head.appendChild(i)}else n(o.createLiffError(s.INVALID_CONFIG,t))}))},$=function(e){var t="https://static.line-scdn.net/lui/edge/versions/1.13.0/lui-alert.js";return t&&e&&(t=t.replace(/\d{1,2}\.\d{1,2}\.\d{1,3}/,e)),Z(t,"LUI_ALERT_URL is not defined")},ee=function(){return e.__awaiter(void 0,void 0,void 0,(function(){var t;return e.__generator(this,(function(e){switch(e.label){case 0:return t=function(){var e,t=document.querySelector('script[src*="luivendor.js"]');if(t&&(null===(e=t.src.match(/\d{1,2}\.\d{1,2}\.\d{1,3}/g))||void 0===e?void 0:e.length))return t.src.match(/\d{1,2}\.\d{1,2}\.\d{1,3}/g)[0]}(),t?[3,2]:[4,Z("https://static.line-scdn.net/lui/edge/versions/1.13.0/luivendor.js","LUI_VENDOR_URL is not defined")];case 1:e.sent(),e.label=2;case 2:return[4,$(t)];case 3:return e.sent(),[4,(r=o.randomAlphaNumericString(6),new Promise((function(){var e=document.createElement("div");e.innerHTML='<lui-alert id="'.concat("liffAlert","-").concat(r,'" shown title="').concat(k.t("alert.android.extBrowser.autoLoginWorkaround.title"),'" message="').concat(k.t("alert.android.extBrowser.autoLoginWorkaround.desc"),'" button="').concat(k.t("alert.android.extBrowser.autoLoginWorkaround.button.text"),'"></lui-alert>'),document.body.appendChild(e);var t=document.getElementById("".concat("liffAlert","-").concat(r));t&&t.addEventListener("lui-button-click",(function(){var e=window.open(o.addParamsToUrl(window.location.href,{liffIsEscapedFromApp:"true"}),"_blank");e&&(e.location.href=o.addParamsToUrl(window.location.href,{liffIsEscapedFromApp:"true"}),window.close())}))})))];case 4:return e.sent(),[2]}var r}))}))},te=function(e){try{return new URL(e).searchParams.get("lineAppVersion")}catch(t){return null}};function re(){return e.__awaiter(this,void 0,void 0,(function(){var t,r,n;return e.__generator(this,(function(e){switch(e.label){case 0:return t=null!==(n=te(window.location.href))&&void 0!==n?n:te(window.document.referrer),!!t&&o.compareVersion(t,"13.10.0")>=0?[2]:l.isInClient()||"android"!==I.getOS()||(r=o.qs.parse(window.location.search))[C.IDENTIFIER_KEY]||r.liffIsEscapedFromApp?[2]:r.liffClientId&&document.referrer.includes("access.".concat("line.me"))?(window.location.href=o.addParamsToUrl(window.location.href,{liffIsEscapedFromApp:"true"}),[2]):r.liffClientId&&document.referrer.includes("android-app://")?[4,ee()]:[3,2];case 1:e.sent(),e.label=2;case 2:return r.liffClientId&&""===document.referrer&&1===window.history.length?[4,ee()]:[3,4];case 3:e.sent(),e.label=4;case 4:return!document.referrer.includes("liffClientId")||document.referrer.includes("liffIsEscapedFromApp")?[3,6]:[4,ee()];case 5:e.sent(),e.label=6;case 6:return[2]}}))}))}var ne=function(t){function o(){var r=t.apply(this,e.__spreadArray([],e.__read(arguments),!1))||this;return r.hooks={before:new T.AsyncHook,after:new T.AsyncHook},r.internalHooks={beforeFinished:new T.AsyncHook,beforeSuccess:new T.AsyncHook,error:new T.AsyncHook},r}return e.__extends(o,t),Object.defineProperty(o.prototype,"name",{get:function(){return"init"},enumerable:!1,configurable:!0}),o.prototype.install=function(e){var t=e.liff;return this.liffForWindow=t,this.init.bind(this)},o.prototype.init=function(t,o,i){return e.__awaiter(this,void 0,void 0,(function(){var a;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,this.hooks.before.call()];case 1:e.sent(),s=this.liffForWindow,window&&!window.liff&&(window.liff=s),e.label=2;case 2:return e.trys.push([2,9,,11]),[4,Promise.all([N(this.liffForWindow),X(t,this.internalHooks.beforeFinished.call)])];case 3:return e.sent(),L(),[4,this.internalHooks.beforeSuccess.call()];case 4:return e.sent(),!t.withLoginOnExternalBrowser||n.isLoggedIn()?[3,6]:(b.login(),[4,new Promise((function(){}))]);case 5:e.sent(),e.label=6;case 6:return[4,re()];case 7:return e.sent(),[4,this.hooks.after.call()];case 8:return e.sent(),"function"==typeof o&&o(),r.done(),[3,11];case 9:return a=e.sent(),[4,this.internalHooks.error.call(a)];case 10:throw e.sent(),"function"==typeof i&&i(a),a;case 11:return[2]}var s}))}))},o}(t.LiffModule);exports.InitModule=ne;
