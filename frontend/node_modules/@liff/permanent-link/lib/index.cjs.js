"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var r=require("tslib"),e=require("@liff/consts"),t=require("@liff/util"),n=require("@liff/store"),a=require("@liff/use"),i=/([\x90\x9D\x81\x8D\x8F<"{|}>\\^`“›„•‚ŽŠ…’—ž–‘”‡™‰ŒšŸ‹œ†¥¿©áÄýÍÎðô]|\n|.*#.*#|%(?![0-9A-Fa-f]{2})[^%]{0,2})/,o=function(r){if(i.test(r))throw t.createLiffError(e.INVALID_ARGUMENT,"invalid URL.");var n=new URL(r),a=n.username,o=n.password,f=n.hash,u=n.search;return{username:a,password:o,pathname:n.pathname,hash:f,origin:n.origin,search:u}},f=function(r){return r.substring(1).split("&").filter((function(r){return!/^liff\./.test(r)&&Boolean(r)}))},u=function(r,e){var t=r.substring(e.length);return"/"===t?"":(t.length>0&&"/"!==t[0]&&(t="/"+t),t)},c=function(r){return encodeURIComponent(r).replace(/[!'()*]/g,(function(r){return"%"+r.charCodeAt(0).toString(16).toUpperCase()}))},s=function(e,t){var n=function(e,t){for(var n=r.__spreadArray([],r.__read(e),!1),a=0;a<t.length;a++){var i=t[a],o=n.indexOf(i);o>-1&&n.splice(o,1)}return n}(function(e){var t,n,a=e.replace(/\+/g,"%2B"),i=new URLSearchParams(a),o=[];try{for(var f=r.__values(i.entries()),u=f.next();!u.done;u=f.next()){var s=r.__read(u.value,2),l=s[0],h=s[1];o.push("".concat(c(l),"=").concat(c(h)))}}catch(p){t={error:p}}finally{try{u&&!u.done&&(n=f.return)&&n.call(f)}finally{if(t)throw t.error}}if(0===o.length)return[""];var d=e.split("&");return o.map((function(r,e){return r.endsWith("=")&&!d[e].endsWith("=")?r.slice(0,-1):r}))}(f(e).join("&")),f(t)).join("&");return""!==n?"?".concat(n):""},l=function(r){var t=new RegExp("^".concat(e.CREDENTIAL_KEYS.join("|"))),n=r.substring(1).split("&").filter((function(r){return!t.test(r)&&Boolean(r)})).join("&");return n?"#".concat(n):""},h=function(r,e){return 0===e.indexOf(r)&&(r.endsWith("/")&&(r=r.substring(0,r.length-1)),void 0===e[r.length]||"/"===e[r.length])},d=function(r,n){var a=o(r),i=new URL(n);if(a.username!==i.username||a.password!==i.password)throw t.createLiffError(e.INVALID_ARGUMENT,"invalid URL.");if(i.origin!==a.origin||!h(i.pathname,a.pathname))throw t.createLiffError(e.INVALID_ARGUMENT,"invalid URL.")},p=function(a){function i(){var i=a.apply(this,r.__spreadArray([],r.__read(arguments),!1))||this;return i.extraParams="",i.getAndValidateContext=function(){var r=n.getContext();if(!r)throw t.createLiffError(e.INIT_FAILED,"Could not get Context from server.");if(!r.endpointUrl)throw t.createLiffError(e.INIT_FAILED,"Could not get endpointUrl from server.");if(!r.permanentLinkPattern)throw t.createLiffError(e.INIT_FAILED,"Could not get permanentLinkPattern from server.");return r},i.createUrl=function(){var r=i.getAndValidateContext(),a=window.location,o=a.pathname,f=a.search,u=a.hash,c=a.origin,s=new URL(r.endpointUrl);if(s.origin!==c||!h(s.pathname,o))throw t.createLiffError(e.INVALID_CONFIG,"Current page is not under entrypoint.");var l=o.substring(s.pathname.length);l.length>0&&"/"!==l[0]&&(l="/"+l);var d=new RegExp("^".concat(e.CREDENTIAL_KEYS.join("|"))),p=u.substring(1).split("&").filter((function(r){return!d.test(r)&&Boolean(r)})).join("&"),g=p===s.hash.substring(1)?"":p,m=function(r){return r.substring(1).split("&").filter((function(r){return!/liff\.state/.test(r)&&Boolean(r)}))},I=m(f),_=m(s.search);i.extraParams&&I.push(i.extraParams);for(var v=0;v<_.length;v++){var L=_[v],E=I.indexOf(L);E>-1&&I.splice(E,1)}var x=I.join("&"),A="".concat(l).concat(""!==x?"?".concat(x):"").concat(g?"#".concat(g):"");return"".concat(e.PERMANENT_LINK_ORIGIN).concat(n.getConfig().liffId).concat(A)},i.createUrlBy=function(a){return r.__awaiter(i,void 0,void 0,(function(){var i,f,c,h,p,g;return r.__generator(this,(function(r){if(!(i=n.getConfig().liffId))throw t.createLiffError(e.INIT_FAILED,"Should run after liff init.");return f=this.getAndValidateContext(),d(a,f.endpointUrl),c=o(a),h=new URL(f.endpointUrl),p=f.miniDomainAllowed?e.PERMANENT_LINK_ORIGIN_MINI:e.PERMANENT_LINK_ORIGIN,g=f.miniDomainAllowed&&f.miniAppId?f.miniAppId:i,[2,p.concat(g,u(c.pathname,h.pathname),s(c.search,h.search),l(c.hash))]}))}))},i.setExtraQueryParam=function(r){i.extraParams=r},i.install=function(){return{createUrl:i.createUrl,createUrlBy:i.createUrlBy,setExtraQueryParam:i.setExtraQueryParam}},i}return r.__extends(i,a),Object.defineProperty(i.prototype,"name",{get:function(){return"permanentLink"},enumerable:!1,configurable:!0}),i}(a.LiffModule),g=new p;exports.PermanentLinkModule=p,exports.module=g,exports.validatePermalinkGeneratability=d;
